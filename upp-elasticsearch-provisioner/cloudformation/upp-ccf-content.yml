AWSTemplateFormatVersion: 2010-09-09
Description: >
  Template to spin-up an OpenSearch cluster that contains FT content used by CCF platform

Parameters:
  EnvironmentType:
    Description: Environment type (Dev,Test or Production).
    Type: String
    AllowedValues:
      - 'd'
      - 't'
      - 'p'
    Default: t
  ClusterName:
    Description: The name of the ES cluster
    Type: String
  Region:
    Description: AWS region - only used to generate the domain access policy
    Type: String
    AllowedValues:
      - 'eu-west-1'
      - 'us-east-1'
    Default: eu-west-1

Resources:
  BackupBucketPolicy:
    Type: "AWS::S3::BucketPolicy"
    Properties:
      Bucket:
        Ref: BackupBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          Effect: "Allow"
          Action: "s3:*"
          Resource:
            - !Join [ "", [ !GetAtt BackupBucket.Arn, "/*" ] ]
            - !GetAtt BackupBucket.Arn
          Principal:
            AWS: !Join [ "", [ "arn:aws:iam::", !Ref 'AWS::AccountId', ":role/upp-elasticsearch-backup-role" ] ]

  BackupBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName: !Join ["", [!Ref ClusterName, "-backup"]]
      Tags:
        - Key: environment
          Value: !Ref EnvironmentType
        - Key: teamDL
          Value: "universal.publishing.platform@ft.com"
        - Key: systemCode
          Value: "upp"
        - Key: description
          Value: !Ref ClusterName

  OpenSearchDomain:
    Type: "AWS::OpenSearchService::Domain"
    Properties:
      DomainName: !Ref ClusterName
      EngineVersion: "1.3"
      ClusterConfig:
        InstanceCount: "3"
        InstanceType: "m5.xlarge.search"
        DedicatedMasterEnabled: "true"
        DedicatedMasterType: "m5.large.search"
        DedicatedMasterCount: "3"
      EBSOptions:
        EBSEnabled: true
        Iops: 0
        VolumeSize: 50
        VolumeType: "gp2"
      SnapshotOptions:
        AutomatedSnapshotStartHour: "0"
      AdvancedOptions:
        rest.action.multi.allow_explicit_index: "true"
      Tags:
        - Key: environment
          Value: !Ref EnvironmentType
        - Key: teamDL
          Value: "universal.publishing.platform@ft.com"
        - Key: systemCode
          Value: "upp"
        - Key: description
          Value: !Ref ClusterName

Outputs:
  ESClusterEndpoint:
    Description: The OpenSearch cluster endpoint
    Value: !GetAtt OpenSearchDomain.DomainEndpoint
