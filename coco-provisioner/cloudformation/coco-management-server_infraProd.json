{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Coco management server built on Amazon Linux with FT integration - InfraProd",
    "Resources": {
        "CocoManagementServer": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "IamInstanceProfile": "FT-Linux-Role",
                "ImageId": "ami-f9dd458a",
                "InstanceType": "t2.micro",
                "SecurityGroupIds": ["sg-1beb8b7e", "sg-9591fbf0"],
                "SubnetId": "subnet-c96755bd",
                "Tags": [
                    { "Key": "Name", "Value": "CocoManagementServer" },
                    { "Key": "description", "Value": "UP, Coco management server" },
                    { "Key": "environment", "Value": "d" },
                    { "Key": "ipCode", "Value": "P196" },
                    { "Key": "ec2Powercycle", "Value": "{ \"start\": \"0 8 * * 1-5\", \"stop\": \"55 17 * * 1-5\" }" },
                    { "Key": "systemCode", "Value": "Content-Containers" },
                    { "Key": "teamDL", "Value": "universal.publishing.platform@ft.com" },
                    { "Key": "stopSchedule", "Value": "nostop" }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash\n",
                                "# FT Base Bootstrap\n",
                                "/usr/bin/aws s3 cp s3://ft-ce-repository/amazon-ftbase/releases/bootstrap.sh /\n",
                                "bash /bootstrap.sh -s eng -e d\n",
                                "# Install Docker and Go environments\n",
                                "/usr/bin/yum install -y docker git golang\n",
                                "/bin/mkdir -p ~/gopath\n",
                                "/bin/echo export GOPATH=\"~/gopath\" >> ~/.bashrc\n",
                                "# Upgrade packages\n",
                                "/usr/bin/yum update -y\n",
                                "# Update Name tag\n",
                                "export REGION=$(/usr/bin/wget -q -O - http://169.254.169.254/latest/meta-data/hostname | cut -d . -f 2)\n",
                                "/usr/bin/aws ec2 --region ${REGION} delete-tags --resources $(wget -q -O - http://169.254.169.254/latest/meta-data/instance-id) --tags Key=Name\n",
                                "/usr/bin/aws ec2 --region ${REGION} create-tags --resources $(wget -q -O - http://169.254.169.254/latest/meta-data/instance-id) --tags Key=Name,Value=$(wget -q -O - http://169.254.169.254/latest/meta-data/hostname)\n"
                            ]
                        ]
                    }
                }
            }
        }
    }
}