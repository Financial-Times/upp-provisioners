Description: "Creates S3 Bucket, SNS Topic and SQS Queues for publishing concepts in UPP."

Parameters:
  EnvironmentTag:
    Type: String
    Default: "pre-prod"
  EnvironmentType:
    Type: String
    Default: "t"
  Region:
    Type: String
    Default: "Secondary region"

Resources:
  # Create the topic and the policy.
  SNSTopic:
    Type: "AWS::SNS::Topic"
    Properties:
      DisplayName: !Join ["", ["Concept Publish Update Notifications - ", !Ref EnvironmentTag]]

  SNSTopicPolicy:
    Type: "AWS::SNS::TopicPolicy"
    Properties:
      PolicyDocument:
        Id: ConceptNotificationTopicPolicy
        Version: '2012-10-17'
        Statement:
          - Sid: allow-s3-publish
            Effect: Allow
            Principal:
              AWS: "*"
            Action: sns:Publish
            Resource: !Ref SNSTopic
            Condition:
              ArnLike: 
                "aws:SourceArn": !Join ["" , ["arn:aws:s3:::", "upp-concept-normalised-store-", !Ref EnvironmentTag]]
      Topics: 
        - !Ref SNSTopic

  # Create the first SQS queue - this always happens.
  SNSDeadLetterQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      QueueName: !Join ["", ["upp-concept-publish-dead-letter-", !Ref EnvironmentTag, "-1"]]

  SQSQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      QueueName: !Join ["", ["upp-concept-publish-notifications-", !Ref EnvironmentTag, "-1"]]
      ReceiveMessageWaitTimeSeconds: 20
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt SNSDeadLetterQueue.Arn
        maxReceiveCount: 5

  SQSQueuePolicy:
    Type: "AWS::SQS::QueuePolicy"
    Properties:
      Queues:
        - !Ref SQSQueue
      PolicyDocument:
        Version: "2012-10-17"
        Id: ConceptNotificationQueuePolicy
        Statement:
          -
            Sid: "receive-from-sns"
            Effect: "Allow"
            Principal:
              AWS: "*"
            Action: "SQS:SendMessage"
            Resource: !GetAtt SQSQueue.Arn
            Condition:
              ArnLike:
                "aws:SourceArn": !Join ["", ["arn:aws:sns:eu-west-1:027104099916:upp-concept-publishing-", !Ref EnvironmentTag, "-SNSTopic*"]]
          -
            Sid: "communicate-with-sqs"
            Effect: "Allow"
            Principal:
              AWS: "arn:aws:iam::027104099916:user/content-containers-apps"
            Action: "SQS:*"
            Resource: !GetAtt SQSQueue.Arn

  SQSSubscription:
    Type: "AWS::SNS::Subscription"
    Properties: 
      Endpoint: !GetAtt SQSQueue.Arn
      Protocol: sqs
      TopicArn: !Ref SNSTopic

  # Create the S3 bucket with the notifications.
  S3ConceptPublish:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName: !Join [ "", ["upp-concept-normalised-store-", !Ref EnvironmentTag]]
      AccessControl: AuthenticatedRead
      NotificationConfiguration:
        TopicConfigurations:
          - Event: "s3:ObjectCreated:*"
            Topic: !Ref SNSTopic

  # Create the concordance store table. 
  ConcordanceStoreDynamoDB:
    Type: "AWS::DynamoDB::Table"
    Properties: 
      AttributeDefinitions:
      - AttributeName: "conceptId"
        AttributeType: "S"
      KeySchema:
      - AttributeName: "conceptId"
        KeyType: "HASH"
      ProvisionedThroughput:
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      TableName: !Join [ "", ["upp-concordance-store-", !Ref EnvironmentTag]]

  # Create the concept notification stream
  ConceptNotificationStream:
    Type: "AWS::Kinesis::Stream"
    Properties:
      Name: !Join [ "", ["upp-concept-notification-stream-", !Ref EnvironmentTag]]
      RetentionPeriodHours: 24
      ShardCount: 1
      Tags:
        - Key: "systemCode"
          Value: "upp"
        - Key: "teamDL"
          Value: "universal.publishing@ft.com"
        - Key: "environment"
          Value: !Ref EnvironmentType
        - Key: "description"
          Value: !Join ["", ["Concept Notification Stream - ", !Ref EnvironmentTag]]

  # DynamoDB autoscaling for read throughput
  ReadCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 15
      MinCapacity: 5
      ResourceId: !Join
        - /
        - - table
          - !Ref ConcordanceStoreDynamoDB
      RoleARN: arn:aws:iam::027104099916:role/service-role/DynamoDBAutoscaleRole
      ScalableDimension: dynamodb:table:ReadCapacityUnits
      ServiceNamespace: dynamodb
  ReadScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: ReadAutoScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref ReadCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 90.0
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBReadCapacityUtilization

  # DynamoDB autoscaling for write throughput
  WriteCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 15
      MinCapacity: 5
      ResourceId: !Join
        - /
        - - table
          - !Ref ConcordanceStoreDynamoDB
      RoleARN: arn:aws:iam::027104099916:role/service-role/DynamoDBAutoscaleRole
      ScalableDimension: dynamodb:table:WriteCapacityUnits
      ServiceNamespace: dynamodb
  WriteScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: WriteAutoScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref WriteCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 90.0
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBWriteCapacityUtilization